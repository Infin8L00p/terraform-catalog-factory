AWSTemplateFormatVersion: '2010-09-09'
Description: Git-synced Service Catalog product wired to a portfolio with a launch role constraint

Parameters:
  ProductName:
    Type: String
  ProductOwner:
    Type: String
  ConnectionArn:
    Type: String
    Description: CodeConnections connection ARN (e.g., arn:aws:codeconnections:eu-west-2:123456789012:connection/uuid)
  Repository:
    Type: String
    Description: GitHub/Bitbucket repo in the form "org/repo"
  Branch:
    Type: String
    Description: Branch to watch (e.g., main)
  ArtifactPath:
    Type: String
    Description: Path to the template file within the repo
  InitialVersionName:
    Type: String
    Default: initial
  PortfolioId:
    Type: String
    Description: Service Catalog Portfolio ID (e.g., port-abc123)
  LaunchRoleArn:
    Type: String
    Default: ""
    Description: (Optional) Absolute RoleArn to use for the launch constraint. Leave empty if using LocalRoleName.
  LaunchLocalRoleName:
    Type: String
    Default: ""
    Description: (Recommended for multi-account) Role name that must exist in the consumer account

Conditions:
  UseLocalRoleName: !Not [!Equals [!Ref LaunchLocalRoleName, ""]]
  UseRoleArnOnly: !And
    - !Equals [!Ref LaunchLocalRoleName, ""]
    - !Not [!Equals [!Ref LaunchRoleArn, ""]]

Resources:
  Product:
    Type: AWS::ServiceCatalog::CloudFormationProduct
    Properties:
      Name: !Ref ProductName
      Owner: !Ref ProductOwner
      ProductType: CLOUD_FORMATION_TEMPLATE
      ProvisioningArtifactParameters:
        - Name: !Ref InitialVersionName
          Type: CLOUD_FORMATION_TEMPLATE
      SourceConnection:
        Type: CODESTAR
        ConnectionParameters:
          CodeStar:
            ConnectionArn: !Ref ConnectionArn
            Repository: !Ref Repository
            Branch: !Ref Branch
            ArtifactPath: !Ref ArtifactPath

  Assoc:
    Type: AWS::ServiceCatalog::PortfolioProductAssociation
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref Product

  LaunchConstraintLocal:
    Condition: UseLocalRoleName
    Type: AWS::ServiceCatalog::LaunchRoleConstraint
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref Product
      LocalRoleName: !Ref LaunchLocalRoleName
      Description: Launch role constraint (LocalRoleName) for multi-account consumption

  LaunchConstraintArn:
    Condition: UseRoleArnOnly
    Type: AWS::ServiceCatalog::LaunchRoleConstraint
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref Product
      RoleArn: !Ref LaunchRoleArn
      Description: Launch role constraint (RoleArn)

Outputs:
  ProductId:
    Description: Service Catalog Product ID (prod-*)
    Value: !Ref Product
  ProductName:
    Description: Service Catalog Product Name
    Value: !GetAtt Product.ProductName
